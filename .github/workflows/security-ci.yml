name: ğŸ›¡ï¸ Phoenix Security Audit

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Audit sÃ©curitÃ© automatique chaque lundi Ã  6h
    - cron: '0 6 * * 1'

permissions:
  contents: read
  security-events: write
  actions: read

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"

jobs:
  python-security:
    name: ğŸ Python Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: ğŸ”§ Install Security Tools
        run: |
          pip install bandit safety pip-audit
          echo "âœ… Security tools installed"
          
      - name: ğŸ” Bandit SAST Scan
        run: |
          echo "ğŸ” Running Bandit security scan..."
          bandit -r apps packages -x tests -lll -f json -o bandit-report.json || true
          bandit -r apps packages -x tests -lll
          echo "âœ… Bandit SAST completed"
          
      - name: ğŸ›¡ï¸ Dependencies Security Audit
        run: |
          echo "ğŸ›¡ï¸ Auditing Python dependencies..."
          safety check --json --output safety-report.json || echo "âš ï¸ Potential vulnerabilities found"
          safety check --short-report || echo "âš ï¸ Check safety-report.json for details"
          echo "âœ… Python dependencies audit completed"
          
      - name: ğŸ“Š Advanced Vulnerability Scan  
        run: |
          echo "ğŸ“Š Running pip-audit..."
          pip-audit --format=json --output=pip-audit-report.json || echo "âš ï¸ Potential vulnerabilities found"
          pip-audit --desc || echo "âš ï¸ Check pip-audit-report.json for details"
          echo "âœ… Advanced vulnerability scan completed"
          
      - name: ğŸ“‹ Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-security-reports
          path: "*-report.json"
          retention-days: 30

  javascript-security:
    name: ğŸŒ JavaScript Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'apps/phoenix-website/package-lock.json'
          
      - name: ğŸ“¦ Install Dependencies
        working-directory: apps/phoenix-website
        run: |
          npm ci
          echo "âœ… Node dependencies installed"
          
      - name: ğŸ” NPM Security Audit
        working-directory: apps/phoenix-website
        run: |
          echo "ğŸ” Running npm security audit..."
          npm audit --audit-level=high --json > npm-audit-report.json || echo "âš ï¸ Vulnerabilities found"
          npm audit --audit-level=high || echo "âš ï¸ Check npm-audit-report.json for details"
          echo "âœ… NPM security audit completed"
          
      - name: ğŸ“‹ Upload JS Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: javascript-security-reports
          path: "apps/phoenix-website/npm-audit-report.json"
          retention-days: 30

  security-summary:
    name: ğŸ¯ Security Audit Summary
    runs-on: ubuntu-latest
    needs: [python-security, javascript-security]
    if: always()
    
    steps:
      - name: ğŸ“Š Download Security Reports
        uses: actions/download-artifact@v4
        with:
          pattern: "*-security-reports"
          merge-multiple: true
          
      - name: ğŸ¯ Generate Security Summary
        run: |
          echo "ğŸ¯ Phoenix Ecosystem Security Audit Summary"
          echo "=============================================="
          echo "ğŸ“… Audit Date: $(date)"
          echo "ğŸ” Python Security: ${{ needs.python-security.result }}"
          echo "ğŸŒ JavaScript Security: ${{ needs.javascript-security.result }}"
          
          if [ "${{ needs.python-security.result }}" == "success" ] && [ "${{ needs.javascript-security.result }}" == "success" ]; then
            echo "âœ… Overall Security Status: PASSED"
          else
            echo "âš ï¸ Overall Security Status: NEEDS ATTENTION"
          fi
          
          echo "ğŸ“‹ Security reports uploaded as artifacts for detailed review"

