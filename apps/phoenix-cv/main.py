"""
üíº Phoenix CV - Application de Cr√©ation de CV IA
Architecture Clean Code et Monorepo - Compatible Docker/Render
"""

import os
import sys
import logging
from pathlib import Path

import streamlit as st

# === Configuration Monorepo Path ===
current_dir = Path(__file__).resolve().parent
monorepo_root = current_dir.parent.parent
packages_dir = monorepo_root / "packages"

# Ajout des packages au path
if str(packages_dir) not in sys.path:
    sys.path.insert(0, str(packages_dir))

# === Imports Phoenix CV ===
from ui_components import PhoenixCVUIComponents
from services import PhoenixCVServiceManager, EnvironmentValidator, CVServiceContainer
from auth_manager import PhoenixCVAuthManager

# === Configuration Logging ===
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)


class PhoenixCVApp:
    """Application Phoenix CV - Clean Architecture"""
    
    def __init__(self):
        self.auth_manager = PhoenixCVAuthManager()
        self.service_manager = PhoenixCVServiceManager()
        self.services: CVServiceContainer = None
        self.ui_components = PhoenixCVUIComponents
        
    def run(self) -> None:
        """Point d'entr√©e principal de l'application"""
        
        # Configuration Streamlit
        st.set_page_config(
            page_title="üíº Phoenix CV - Cr√©ateur IA",
            page_icon="üíº",
            layout="wide",
            initial_sidebar_state="expanded",
        )
        
        # Chargement des styles CSS
        self.ui_components.load_css_styles()
        
        # Validation environnement
        self._validate_environment()
        
        # Initialisation services
        self._initialize_services()
        
        # Gestion authentication
        if not self.auth_manager.is_authenticated():
            self._handle_unauthenticated_flow()
            return
            
        # Application principale
        self._render_authenticated_app()
    
    def _validate_environment(self) -> None:
        """Valide la configuration environnement"""
        validation = EnvironmentValidator.validate_environment()
        
        if not validation["valid"]:
            st.error("‚ùå Configuration Phoenix CV manquante")
            st.write(EnvironmentValidator.get_validation_summary())
            st.info("""
            **Variables requises pour Phoenix CV :**
            - `GOOGLE_API_KEY` : Pour l'IA Gemini
            
            **Variables optionnelles :**
            - `STRIPE_SECRET_KEY` : Pour les paiements Premium
            - `SUPABASE_URL` + `SUPABASE_ANON_KEY` : Pour l'authentification
            """)
            st.stop()
    
    def _initialize_services(self) -> None:
        """Initialise tous les services Phoenix CV"""
        try:
            self.services = self.service_manager.initialize_all_services()
            
            if self.services.error:
                st.warning(f"‚ö†Ô∏è Services partiellement disponibles: {self.services.error}")
            else:
                logger.info("‚úÖ Services Phoenix CV initialis√©s avec succ√®s")
                
        except Exception as e:
            logger.error(f"Erreur initialisation services: {e}")
            st.error(f"‚ùå Impossible d'initialiser Phoenix CV: {e}")
            st.stop()
    
    def _handle_unauthenticated_flow(self) -> None:
        """G√®re le flux pour utilisateurs non authentifi√©s"""
        
        # En-t√™te application
        self.ui_components.render_login_form_header()
        
        # Teaser gratuit pour inciter √† l'inscription
        st.markdown("---")
        generated_cv = self.ui_components.render_quick_cv_generator()
        
        if generated_cv:
            st.markdown("---")
            st.info("üíé **Cr√©ez un compte pour des CV plus professionnels !**")
        
        st.markdown("---")
        
        # Page de connexion/inscription
        self.auth_manager.render_login_page()
        
        # Footer s√©curis√©
        self.ui_components.render_security_footer()
    
    def _render_authenticated_app(self) -> None:
        """Rendu application pour utilisateurs authentifi√©s"""
        
        current_user = self.auth_manager.get_current_user()
        
        # En-t√™te principal
        self.ui_components.render_app_header()
        
        # Sidebar navigation
        self._render_sidebar(current_user)
        
        # Contenu principal selon navigation
        selected_page = st.session_state.get("cv_selected_page", "creator")
        
        if selected_page == "creator":
            self._render_cv_creator_page(current_user)
        elif selected_page == "templates":
            self._render_templates_page(current_user)
        elif selected_page == "history":
            self._render_history_page(current_user)
        elif selected_page == "settings":
            self._render_settings_page(current_user)
        else:
            self._render_dashboard_page(current_user)
            
        # Footer inspirant
        self.ui_components.render_inspirational_footer()
    
    def _render_sidebar(self, current_user) -> None:
        """Rendu sidebar navigation"""
        
        with st.sidebar:
            st.markdown(f"### üëã Bonjour {current_user.email.split('@')[0]} !")
            
            # Statut utilisateur
            if current_user.user_tier == "PREMIUM":
                st.success("üíé Compte Premium")
            else:
                st.info("üÜì Compte Gratuit")
                if st.button("üîì Passer √† Premium"):
                    st.balloons()
                    st.info("Fonctionnalit√© bient√¥t disponible !")
            
            st.markdown("---")
            
            # Navigation
            st.markdown("### üìÇ Navigation")
            
            pages = {
                "dashboard": "üìä Tableau de Bord",
                "creator": "‚ú® Cr√©ateur de CV", 
                "templates": "üìã Templates",
                "history": "üìö Historique",
                "settings": "‚öôÔ∏è Param√®tres"
            }
            
            for page_key, page_name in pages.items():
                if st.button(page_name, key=f"nav_{page_key}"):
                    st.session_state.cv_selected_page = page_key
                    st.rerun()
            
            st.markdown("---")
            
            # D√©connexion
            if st.button("üö™ Se d√©connecter"):
                self.auth_manager.logout()
    
    def _render_dashboard_page(self, current_user) -> None:
        """Page tableau de bord"""
        st.markdown("## üìä Tableau de Bord Phoenix CV")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.metric("CV Cr√©√©s", "0", "Nouveau compte")
        
        with col2:
            st.metric("Templates Utilis√©s", "0", "D√©couvrez nos mod√®les")
        
        with col3:
            st.metric("Optimisations ATS", "0", "Boostez vos candidatures")
        
        st.markdown("### üöÄ Actions Rapides")
        
        col_action1, col_action2 = st.columns(2)
        
        with col_action1:
            if st.button("‚ú® Cr√©er un nouveau CV", use_container_width=True):
                st.session_state.cv_selected_page = "creator"
                st.rerun()
        
        with col_action2:
            if st.button("üìã Parcourir les templates", use_container_width=True):
                st.session_state.cv_selected_page = "templates"
                st.rerun()
    
    def _render_cv_creator_page(self, current_user) -> None:
        """Page cr√©ateur de CV"""
        st.markdown("## ‚ú® Cr√©ateur de CV Phoenix")
        
        if current_user.user_tier != "PREMIUM":
            self.ui_components.render_free_upgrade_banner()
        
        # Formulaire cr√©ation CV
        with st.form("cv_creator_form"):
            st.markdown("### üë§ Informations Personnelles")
            
            col1, col2 = st.columns(2)
            
            with col1:
                full_name = st.text_input("Nom complet", placeholder="Jean Dupont")
                job_title = st.text_input("Titre du poste", placeholder="D√©veloppeur Senior")
                email = st.text_input("Email", placeholder="jean.dupont@email.com")
            
            with col2:
                phone = st.text_input("T√©l√©phone", placeholder="06 12 34 56 78")
                location = st.text_input("Localisation", placeholder="Paris, France")
                linkedin = st.text_input("LinkedIn", placeholder="linkedin.com/in/jean-dupont")
            
            st.markdown("### üíº Exp√©rience Professionnelle")
            experience = st.text_area(
                "D√©crivez votre exp√©rience",
                placeholder="Ex: 5 ans en d√©veloppement Python...",
                height=150
            )
            
            st.markdown("### üõ†Ô∏è Comp√©tences")
            skills = st.text_area(
                "Listez vos comp√©tences",
                placeholder="Python, React, Docker, AWS...",
                height=100
            )
            
            st.markdown("### üéì Formation")
            education = st.text_area(
                "Votre parcours √©ducatif",
                placeholder="Master en Informatique - Universit√©...",
                height=100
            )
            
            # Bouton g√©n√©ration
            generate_cv = st.form_submit_button(
                "üöÄ G√©n√©rer mon CV Phoenix",
                type="primary",
                use_container_width=True
            )
        
        if generate_cv:
            if full_name and job_title and experience and skills:
                with st.spinner("‚ú® G√©n√©ration de votre CV professionnel..."):
                    # G√©n√©ration CV
                    cv_content = self._generate_professional_cv(
                        full_name, job_title, email, phone, location, linkedin,
                        experience, skills, education
                    )
                    
                    st.success("‚úÖ CV g√©n√©r√© avec succ√®s !")
                    st.markdown("### üìÑ Votre CV Professionnel Phoenix")
                    
                    st.text_area(
                        "",
                        value=cv_content,
                        height=500,
                        key="generated_professional_cv"
                    )
                    
                    # Actions
                    col_dl, col_edit, col_share = st.columns(3)
                    
                    with col_dl:
                        st.download_button(
                            "üì• T√©l√©charger",
                            data=cv_content,
                            file_name=f"cv_{full_name.lower().replace(' ', '_')}_phoenix.txt",
                            mime="text/plain"
                        )
                    
                    with col_edit:
                        if current_user.user_tier == "PREMIUM":
                            st.button("‚úèÔ∏è √âditer", disabled=True, help="Bient√¥t disponible")
                        else:
                            self.ui_components.render_premium_teaser(
                                "√âditeur Avanc√©",
                                "Personnalisez votre CV avec notre √©diteur intelligent",
                                "premium_editor"
                            )
                    
                    with col_share:
                        if current_user.user_tier == "PREMIUM":
                            st.button("üîó Partager", disabled=True, help="Bient√¥t disponible")
                        else:
                            self.ui_components.render_premium_teaser(
                                "Partage Pro",
                                "Partagez votre CV avec un lien professionnel",
                                "premium_share"
                            )
            else:
                st.error("‚ùå Veuillez remplir au moins le nom, poste, exp√©rience et comp√©tences")
    
    def _generate_professional_cv(
        self, full_name: str, job_title: str, email: str, phone: str,
        location: str, linkedin: str, experience: str, skills: str, education: str
    ) -> str:
        """G√©n√®re un CV professionnel format√©"""
        
        return f"""
# {full_name}
## {job_title}

### üìß Contact
- Email: {email}
- T√©l√©phone: {phone if phone else 'N/A'}
- Localisation: {location if location else 'N/A'}
- LinkedIn: {linkedin if linkedin else 'N/A'}

---

### üíº Exp√©rience Professionnelle
{experience}

### üõ†Ô∏è Comp√©tences Techniques
{skills}

### üéì Formation
{education if education else '√Ä compl√©ter...'}

### üéØ Profil Professionnel
{job_title} exp√©riment√©(e) passionn√©(e) par l'innovation et l'excellence technique. 
Fort d'une solide exp√©rience dans le domaine, je m'engage √† apporter 
une valeur ajout√©e significative aux projets et √©quipes.

### üåü Objectifs de Carri√®re
Contribuer au succ√®s d'une entreprise innovante en mettant √† profit 
mes comp√©tences en {job_title.lower()} et ma passion pour les d√©fis techniques.

---
*CV g√©n√©r√© par Phoenix CV - Votre partenaire pour une carri√®re r√©ussie*
*Optimis√© pour les syst√®mes ATS (Applicant Tracking System)*
        """
    
    def _render_templates_page(self, current_user) -> None:
        """Page des templates"""
        st.markdown("## üìã Templates Phoenix CV")
        
        templates = [
            {"name": "Moderne", "description": "Design √©pur√© et professionnel", "premium": False},
            {"name": "Cr√©atif", "description": "Pour les profils artistiques", "premium": True},
            {"name": "Tech", "description": "Optimis√© pour les d√©veloppeurs", "premium": True},
            {"name": "Executive", "description": "Pour les postes de direction", "premium": True},
        ]
        
        cols = st.columns(2)
        
        for i, template in enumerate(templates):
            with cols[i % 2]:
                if template["premium"] and current_user.user_tier != "PREMIUM":
                    # Template premium pour utilisateur gratuit
                    st.markdown(f"""
                    <div style="border: 2px dashed #fbbf24; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                        <h4>üîí {template['name']} (Premium)</h4>
                        <p>{template['description']}</p>
                    </div>
                    """, unsafe_allow_html=True)
                    
                    if st.button(f"üîì D√©bloquer {template['name']}", key=f"template_{i}"):
                        st.info("üíé Passez √† Premium pour acc√©der √† ce template !")
                else:
                    # Template gratuit ou utilisateur premium
                    st.markdown(f"""
                    <div style="border: 2px solid #10b981; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                        <h4>‚úÖ {template['name']}</h4>
                        <p>{template['description']}</p>
                    </div>
                    """, unsafe_allow_html=True)
                    
                    if st.button(f"üìã Utiliser {template['name']}", key=f"use_template_{i}"):
                        st.success(f"Template {template['name']} s√©lectionn√© ! Fonctionnalit√© bient√¥t disponible.")
    
    def _render_history_page(self, current_user) -> None:
        """Page historique"""
        st.markdown("## üìö Historique de vos CV")
        
        st.info("üîÑ Fonctionnalit√© en d√©veloppement")
        st.markdown("""
        Bient√¥t disponible :
        - üìã Liste de tous vos CV cr√©√©s
        - üìä Statistiques de performance
        - üîÑ Versions et r√©visions
        - üì§ Historique des candidatures
        """)
    
    def _render_settings_page(self, current_user) -> None:
        """Page param√®tres"""
        st.markdown("## ‚öôÔ∏è Param√®tres du Compte")
        
        st.markdown("### üë§ Informations du Compte")
        st.text_input("Email", value=current_user.email, disabled=True)
        st.text_input("Statut", value=current_user.user_tier, disabled=True)
        
        st.markdown("### üîß Pr√©f√©rences")
        st.checkbox("Notifications par email", value=True)
        st.checkbox("Sauvegardes automatiques", value=True)
        st.selectbox("Langue", ["Fran√ßais", "English"], index=0)
        
        st.markdown("### üîí S√©curit√©")
        if st.button("üîê Changer le mot de passe"):
            st.info("Fonctionnalit√© bient√¥t disponible")
        
        if st.button("üì§ Exporter mes donn√©es"):
            st.info("Export RGPD bient√¥t disponible")


def main() -> None:
    """Point d'entr√©e principal"""
    try:
        app = PhoenixCVApp()
        app.run()
    except Exception as e:
        logger.error(f"Erreur critique Phoenix CV: {e}")
        st.error(f"‚ùå Erreur Phoenix CV: {e}")
        st.info("üîÑ Rechargez la page ou contactez le support")


if __name__ == "__main__":
    main()