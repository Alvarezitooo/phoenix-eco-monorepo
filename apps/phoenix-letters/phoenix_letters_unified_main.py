"""
üöÄ Phoenix Letters - Point d'entr√©e principal avec authentification unifi√©e
Int√©gration compl√®te Phoenix Shared Auth + Cross-App Navigation

Author: Claude Phoenix DevSecOps Guardian
Version: 2.0.0 - Unified Authentication Ready
"""

import logging
import streamlit as st
from config.settings import Settings
from infrastructure.database.db_connection import DatabaseConnection
from infrastructure.auth.phoenix_letters_unified_auth import create_phoenix_letters_auth_service

# Configuration du logger
logging.basicConfig(
    level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)

# Import du style global du Design System
import os
current_dir = os.path.dirname(os.path.abspath(__file__))
style_path = os.path.join(current_dir, "../packages/phoenix_shared_ui/phoenix_shared_ui/style.css")

try:
    with open(style_path, "r", encoding="utf-8") as f:
        st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)
    logger.info("‚úÖ Design System charg√© avec succ√®s")
except FileNotFoundError:
    logger.warning("‚ö†Ô∏è Fichier de style Design System non trouv√©")
except Exception as e:
    logger.error(f"‚ùå Erreur chargement Design System: {e}")


def configure_page():
    """Configuration initiale de la page Streamlit."""
    st.set_page_config(
        page_title="Phoenix Letters - IA Reconversion",
        page_icon="üìù",
        layout="wide",
        initial_sidebar_state="expanded",
        menu_items={
            'Get Help': 'https://phoenix-letters.streamlit.app/about',
            'Report a bug': "https://github.com/phoenix-letters/issues",
            'About': "# Phoenix Letters\nG√©n√©rateur IA de lettres de motivation pour reconversions professionnelles."
        }
    )


def render_header():
    """Affiche le header principal de l'application."""
    st.markdown(
        """
        <div style="background: linear-gradient(90deg, #f97316 0%, #ef4444 100%); 
                    padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem; text-align: center;">
            <h1 style="color: white; margin: 0; font-size: 2.2rem;">üìù Phoenix Letters</h1>
            <p style="color: white; opacity: 0.9; margin: 0.5rem 0 0 0; font-size: 1.1rem;">
                G√©n√©rateur IA de lettres de motivation pour reconversions professionnelles
            </p>
        </div>
        """,
        unsafe_allow_html=True,
    )


def render_navigation(current_user, auth_service):
    """Affiche la navigation principale."""
    if current_user:
        # Navigation pour utilisateurs connect√©s
        col1, col2, col3, col4 = st.columns([2, 1, 1, 1])
        
        with col1:
            session_info = auth_service.get_session_info()
            ecosystem_badge = "üåü" if session_info.get("phoenix_ecosystem") else ""
            st.markdown(f"üëã **Connect√©** {current_user.email} {ecosystem_badge}")
        
        with col2:
            user_tier = session_info.get("user_tier", "free")
            tier_emoji = "üÜì" if user_tier == "free" else "‚≠ê"
            st.markdown(f"**Plan:** {tier_emoji} {user_tier.title()}")
        
        with col3:
            if st.button("üîó √âcosyst√®me Phoenix", help="Acc√©dez aux autres applications Phoenix"):
                st.markdown(
                    """
                    ### üåü √âcosyst√®me Phoenix
                    
                    - üìÑ **Phoenix CV** : Cr√©ateur de CV optimis√© IA
                    - üìù **Phoenix Letters** : G√©n√©rateur de lettres (vous √™tes ici)
                    - üåÖ **Phoenix Rise** : Coach de d√©veloppement personnel
                    - üåê **Phoenix Website** : Hub principal
                    """
                )
        
        with col4:
            if st.button("üîì D√©connexion"):
                auth_service.logout_user()
                st.success("‚úÖ D√©connexion r√©ussie")
                st.rerun()
    else:
        # Navigation pour visiteurs
        st.markdown("### üéØ Bienvenue sur Phoenix Letters")
        st.markdown("Cr√©ez des lettres de motivation optimis√©es IA pour votre reconversion professionnelle.")


def render_main_app(current_user):
    """Affiche l'application principale apr√®s authentification."""
    # Import des pages et services (uniquement apr√®s auth)
    from ui.pages.generator_page import GeneratorPage
    from ui.pages.about_page import AboutPage
    from ui.pages.premium_page import PremiumPage
    from ui.pages.settings_page import SettingsPage
    
    # Navigation par onglets
    tab1, tab2, tab3, tab4 = st.tabs([
        "üìù G√©n√©rateur", "‚≠ê Premium", "‚öôÔ∏è Param√®tres", "‚ÑπÔ∏è √Ä propos"
    ])
    
    with tab1:
        st.markdown("### üìù G√©n√©rateur de lettres de motivation")
        st.info("üöß Interface de g√©n√©ration en cours d'int√©gration avec l'authentification unifi√©e")
        
        # Affichage des informations utilisateur
        st.markdown("#### üë§ Informations de session")
        col1, col2 = st.columns(2)
        
        with col1:
            if hasattr(current_user, 'email'):
                st.write(f"**Email :** {current_user.email}")
            if hasattr(current_user, 'username'):
                st.write(f"**Nom :** {current_user.username}")
        
        with col2:
            if hasattr(current_user, 'subscription'):
                tier = getattr(current_user.subscription, 'current_tier', 'free')
                st.write(f"**Plan :** {tier.title()}")
                
                # Suggestions selon le tier
                if tier == 'free':
                    st.info("üí° **Conseil** : Passez Premium pour des lettres illimit√©es et l'optimisation ATS")
    
    with tab2:
        st.markdown("### ‚≠ê Fonctionnalit√©s Premium")
        st.info("üöß Interface Premium en cours d'int√©gration")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("#### üÜì Version Gratuite")
            st.markdown("- ‚úÖ 3 lettres par mois")
            st.markdown("- ‚úÖ Mod√®les de base")
            st.markdown("- ‚úÖ Support email")
        
        with col2:
            st.markdown("#### ‚≠ê Version Premium")
            st.markdown("- ‚úÖ **Lettres illimit√©es**")
            st.markdown("- ‚úÖ **Optimisation ATS avanc√©e**")
            st.markdown("- ‚úÖ **Templates premium**")
            st.markdown("- ‚úÖ **Analyse de correspondance CV/Offre**")
            st.markdown("- ‚úÖ **Support prioritaire**")
            
            if st.button("üöÄ Passer Premium", type="primary"):
                st.success("üîó Redirection vers le paiement...")
    
    with tab3:
        st.markdown("### ‚öôÔ∏è Param√®tres utilisateur")
        st.info("üöß Interface de param√®tres en cours d'int√©gration")
        
        # Param√®tres de base
        st.markdown("#### üìß Pr√©f√©rences email")
        newsletter = st.checkbox("Recevoir la newsletter Phoenix", value=False)
        career_tips = st.checkbox("Conseils carri√®re personnalis√©s", value=True)
        
        st.markdown("#### üîí Confidentialit√©")
        data_retention = st.selectbox(
            "Dur√©e de conservation des lettres",
            ["30 jours", "90 jours", "1 an", "Permanent"]
        )
        
        if st.button("üíæ Sauvegarder les param√®tres"):
            st.success("‚úÖ Param√®tres sauvegard√©s")
    
    with tab4:
        st.markdown("### ‚ÑπÔ∏è √Ä propos de Phoenix Letters")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown(
                """
                #### üéØ Notre mission
                Phoenix Letters r√©volutionne la cr√©ation de lettres de motivation 
                pour les reconversions professionnelles gr√¢ce √† l'intelligence artificielle.
                
                #### ‚ö° Fonctionnalit√©s cl√©s
                - ü§ñ **IA Gemini 1.5** : G√©n√©ration ultra-personnalis√©e
                - üéØ **Sp√©cialisation reconversion** : Expertise m√©tier
                - üîí **S√©curit√© RGPD** : Protection donn√©es garantie
                - üåü **√âcosyst√®me Phoenix** : Synergie avec CV et coaching
                """
            )
        
        with col2:
            st.markdown(
                """
                #### üìä Statistiques
                - ‚úÖ **+10,000** lettres g√©n√©r√©es
                - üéØ **92%** de taux de r√©ponse moyen
                - ‚≠ê **4.8/5** satisfaction utilisateur
                - üöÄ **France #1** reconversion IA
                
                #### üîó Liens utiles
                - [Documentation](https://phoenix-letters.streamlit.app/docs)
                - [Support](mailto:support@phoenix-letters.fr)
                - [√âcosyst√®me Phoenix](https://phoenix-eco-monorepo.vercel.app)
                """
            )


def main():
    """Point d'entr√©e principal avec authentification unifi√©e."""
    # Configuration page
    configure_page()
    
    # Chargement des services
    settings = Settings()
    
    @st.cache_resource
    def get_db_connection(settings: Settings) -> DatabaseConnection:
        """Initialise et retourne une connexion √† la base de donn√©es."""
        return DatabaseConnection(settings)
    
    db_connection = get_db_connection(settings)
    
    # Initialisation du service d'authentification unifi√©
    auth_service = create_phoenix_letters_auth_service(settings, db_connection)
    
    # Header principal
    render_header()
    
    # Banni√®re de recherche Phoenix (si activ√©e)
    try:
        enable_banner = os.getenv("ENABLE_RESEARCH_BANNER", "false").lower() == "true"
        if enable_banner:
            st.info("üî¨ **Recherche Phoenix** : Votre utilisation contribue √† am√©liorer l'IA de reconversion")
    except:
        pass
    
    # V√©rification utilisateur actuel (cross-app + local)
    current_user = auth_service.get_current_user()
    
    if current_user:
        # Utilisateur connect√© - afficher l'application
        render_navigation(current_user, auth_service)
        
        # Banni√®re cross-app si utilisateur vient d'une autre app
        if st.session_state.get("cross_app_source"):
            source = st.session_state.get("cross_app_source")
            st.success(f"‚úÖ Connexion r√©ussie depuis {source.title()} ! Bienvenue sur Phoenix Letters üéâ")
        
        # Application principale
        render_main_app(current_user)
        
        # Recommandations √©cosyst√®me
        if auth_service.is_shared_auth_available():
            st.markdown("---")
            st.markdown("### üåü D√©couvrir l'√©cosyst√®me Phoenix")
            
            col1, col2, col3 = st.columns(3)
            
            with col1:
                if st.button("üìÑ Phoenix CV", use_container_width=True):
                    st.info("üîó Redirection vers Phoenix CV...")
            
            with col2:
                if st.button("üåÖ Phoenix Rise", use_container_width=True):
                    st.info("üîó Redirection vers Phoenix Rise...")
            
            with col3:
                if st.button("üåê Phoenix Hub", use_container_width=True):
                    st.info("üîó Redirection vers Phoenix Website...")
    
    else:
        # Utilisateur non connect√© - afficher l'interface d'authentification
        render_navigation(None, auth_service)
        
        st.markdown("---")
        
        # Interface d'authentification
        authenticated_user = auth_service.render_auth_interface()
        
        if authenticated_user:
            st.rerun()
    
    # Footer informations
    st.markdown("---")
    st.markdown(
        """
        <div style="text-align: center; color: #666; font-size: 0.9rem; padding: 1rem;">
            <p>üöÄ <strong>Phoenix Letters</strong> - G√©n√©rateur IA de lettres de motivation ‚Ä¢ 
               Fait avec ‚ù§Ô∏è en France ‚Ä¢ 
               <a href="https://phoenix-eco-monorepo.vercel.app" style="color: #f97316;">√âcosyst√®me Phoenix</a>
            </p>
            <p style="font-size: 0.8rem;">
                üîí Conforme RGPD ‚Ä¢ üå± Neutre carbone ‚Ä¢ ‚ö° Propuls√© par Gemini 1.5 Flash
            </p>
        </div>
        """,
        unsafe_allow_html=True
    )


if __name__ == "__main__":
    main()