# üß† DATA FLYWHEEL AGENT - Docker optimis√©
FROM python:3.11-slim

# M√©tadonn√©es
LABEL maintainer="Phoenix Letters Team"
LABEL version="1.0.0"
LABEL description="Data Flywheel Agent avec Qwen2.5 optimis√©"

# Variables d'environnement
ENV PYTHONUNBUFFERED=1
ENV OLLAMA_HOST=0.0.0.0
ENV OLLAMA_PORT=11434
ENV MODEL_NAME=qwen2.5:3b
ENV DATABASE_PATH=/app/data/flywheel.db

# Installation des d√©pendances syst√®me
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    sqlite3 \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Installation Ollama
RUN curl -fsSL https://ollama.ai/install.sh | sh

# Cr√©ation utilisateur et r√©pertoires
RUN useradd -m -u 1000 phoenix && \
    mkdir -p /app /app/data /home/phoenix/.ollama && \
    chown -R phoenix:phoenix /app /home/phoenix

# Copie du code
COPY --chown=phoenix:phoenix requirements.txt /app/
COPY --chown=phoenix:phoenix data_flywheel_agent.py /app/
COPY --chown=phoenix:phoenix flywheel_api.py /app/

# Installation d√©pendances
WORKDIR /app
RUN pip install --no-cache-dir -r requirements.txt

# Switch utilisateur
USER phoenix

# Note: Mod√®les t√©l√©charg√©s au premier d√©marrage pour optimiser le build

# Volume pour persistance donn√©es
VOLUME ["/app/data"]

# Sant√© container
HEALTHCHECK --interval=30s --timeout=10s --start-period=90s --retries=3 \
    CMD curl -f http://localhost:11434/api/version || exit 1

# Ports
EXPOSE 11434 8002

# Script d√©marrage
COPY --chown=phoenix:phoenix docker/entrypoint-flywheel.sh /app/
RUN chmod +x /app/entrypoint-flywheel.sh

ENTRYPOINT ["/app/entrypoint-flywheel.sh"]
CMD ["python", "flywheel_api.py"]