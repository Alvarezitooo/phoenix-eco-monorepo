# Phoenix Rise & Dojo Mental - Development Makefile
.PHONY: help dev build test clean seed migrate docker-up docker-down lint format

# Default target
.DEFAULT_GOAL := help

help: ## Show this help message
	@echo "Phoenix Rise & Dojo Mental - Development Commands"
	@echo "================================================="
	@echo ""
	@awk 'BEGIN {FS = ":.*##"; printf "Usage:\n  make \033[36m<target>\033[0m\n\nTargets:\n"} /^[a-zA-Z_-]+:.*?##/ { printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2 }\' $(MAKEFILE_LIST)

# Development
dev: docker-up migrate seed ## Start development environment
	@echo "ğŸš€ Phoenix Rise development environment is ready!"
	@echo "ğŸ“Š Web App: http://localhost:3000"
	@echo "ğŸ”§ API: http://localhost:8000"
	@echo "ğŸ“§ Mailhog: http://localhost:8025"
	@echo "ğŸ“ˆ API Docs: http://localhost:8000/docs"

docker-up: ## Start all services
	@echo "ğŸ³ Starting Docker services..."
	docker-compose up -d
	@echo "â³ Waiting for services to be ready..."
	sleep 10

docker-down: ## Stop all services
	@echo "ğŸ›‘ Stopping Docker services..."
	docker-compose down

docker-clean: ## Stop and remove all containers, networks, and volumes
	@echo "ğŸ§¹ Cleaning up Docker resources..."
	docker-compose down -v --remove-orphans
	docker system prune -f

# Database
migrate: ## Run database migrations
	@echo "ğŸ”„ Running database migrations..."
	docker-compose exec api alembic upgrade head

migrate-create: ## Create new migration (usage: make migrate-create MESSAGE="description")
	@if [ -z "$(MESSAGE)" ]; then \
		echo "âŒ Please provide MESSAGE: make migrate-create MESSAGE=\"your description\""; \
		exit 1; \
	fi
	@echo "ğŸ“ Creating new migration: $(MESSAGE)"
	docker-compose exec api alembic revision --autogenerate -m "$(MESSAGE)"

migrate-rollback: ## Rollback last migration
	@echo "â†©ï¸  Rolling back last migration..."
	docker-compose exec api alembic downgrade -1

seed: ## Seed database with sample data
	@echo "ğŸŒ± Seeding database..."
	docker-compose exec api python scripts/seed_data.py

# Testing
test: test-api test-web ## Run all tests

test-api: ## Run API tests
	@echo "ğŸ§ª Running API tests..."
	docker-compose exec api pytest -v --cov=app --cov-report=html

test-web: ## Run frontend tests
	@echo "ğŸ§ª Running frontend tests..."
	cd apps/web && npm run test

test-e2e: ## Run end-to-end tests
	@echo "ğŸ­ Running E2E tests..."
	cd apps/web && npx playwright test

# Code Quality
lint: lint-api lint-web ## Run all linters

lint-api: ## Lint API code
	@echo "ğŸ” Linting API code..."
	docker-compose exec api mypy .
	docker-compose exec api flake8 .

lint-web: ## Lint frontend code
	@echo "ğŸ” Linting frontend code..."
	cd apps/web && npm run lint

format: format-api format-web ## Format all code

format-api: ## Format API code
	@echo "âœ¨ Formatting API code..."
	docker-compose exec api black .

format-web: ## Format frontend code
	@echo "âœ¨ Formatting frontend code..."
	cd apps/web && npm run format

# Build
build: ## Build all services
	@echo "ğŸ—ï¸  Building services..."
	docker-compose build

build-api: ## Build API service
	@echo "ğŸ—ï¸  Building API..."
	docker-compose build api

build-web: ## Build web service
	@echo "ğŸ—ï¸  Building web app..."
	docker-compose build web

# Production
deploy-prepare: ## Prepare for deployment
	@echo "ğŸ“¦ Preparing for deployment..."
	@$(MAKE) test
	@$(MAKE) lint
	@echo "âœ… Ready for deployment!"

# Monitoring & Debugging
logs: ## Show all service logs
	docker-compose logs -f

logs-api: ## Show API logs
	docker-compose logs -f api

logs-web: ## Show web app logs
	docker-compose logs -f web

logs-db: ## Show database logs
	docker-compose logs -f postgres

shell-api: ## Open shell in API container
	docker-compose exec api bash

shell-db: ## Open PostgreSQL shell
	docker-compose exec postgres psql -U phoenix -d phoenix_rise

health: ## Check service health
	@echo "ğŸ¥ Checking service health..."
	@echo "API:" && curl -s http://localhost:8000/health | jq '.' || echo "âŒ API not responding"
	@echo "Web:" && curl -s http://localhost:3000 > /dev/null && echo "âœ… Web responding" || echo "âŒ Web not responding"
	@echo "Database:" && docker-compose exec postgres pg_isready -U phoenix && echo "âœ… DB responding" || echo "âŒ DB not responding"

# Security
security-scan: ## Run security scans
	@echo "ğŸ”’ Running security scans..."
	docker-compose exec api safety check
	cd apps/web && npm audit

# Cleanup
clean: docker-clean ## Clean up everything
	@echo "ğŸ§¹ Cleaning up..."
	cd apps/web && rm -rf .next node_modules
	cd apps/api && find . -name "*.pyc" -delete
	cd apps/api && find . -name "__pycache__" -type d -exec rm -rf {} +

# Development utilities
reset-db: ## Reset database (WARNING: deletes all data)
	@echo "âš ï¸  WARNING: This will delete all data!"
	@read -p "Are you sure? (y/N): \" confirm && [ $$confirm = "y" ]
	docker-compose down postgres
	docker volume rm phoenix-rise-monorepo_postgres_data
	@$(MAKE) docker-up migrate seed

install-deps: ## Install all dependencies
	@echo "ğŸ“¦ Installing dependencies..."
	cd apps/web && npm install
	cd apps/api && pip install -r requirements.txt

update-deps: ## Update dependencies
	@echo "ğŸ”„ Updating dependencies..."
	cd apps/web && npm update
	cd apps/api && pip install --upgrade -r requirements.txt

# Environment
env-check: ## Check environment variables
	@echo "ğŸ” Environment check..."
	@cd apps/web && node -e "console.log('Web env OK')\" 2>/dev/null && echo "âœ… Web environment" || echo "âŒ Web environment"
	@cd apps/api && python -c "from app.core.config import settings; print('âœ… API environment')\" 2>/dev/null || echo "âŒ API environment"

# Documentation
docs-api: ## Generate API documentation
	@echo "ğŸ“š Generating API docs..."
	docker-compose exec api python -c "import app; print('API docs available at http://localhost:8000/docs')"

# Quick commands for common workflows
quick-dev: docker-clean docker-up migrate seed ## Quick development setup (clean start)
	@echo "ğŸƒ Quick dev setup complete!"

quick-test: ## Quick test run
	@$(MAKE) test-api
	@echo "âœ… Quick tests passed!"

quick-lint: ## Quick lint check
	@$(MAKE) lint-api
	@echo "âœ… Code looks good!"

# CI/CD helpers  
ci-test: ## Run tests for CI
	@echo "ğŸ¤– Running CI tests..."
	pytest apps/api/tests/ -v --cov=apps/api/app --cov-report=xml
	cd apps/web && npm run test:ci

ci-build: ## Build for CI
	@echo "ğŸ¤– Building for CI..."
	docker build -t phoenix-api ./apps/api
	docker build -t phoenix-web ./apps/web